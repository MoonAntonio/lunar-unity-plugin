using System;
using System.Collections.Generic;
using System.Reflection;

using NUnit.Framework;

using LunarPlugin;
using LunarPlugin.Test;
using LunarPluginInternal;

using LunarEditor;

namespace CCommandTests
{
    using Assert = NUnit.Framework.Assert;
    using Option = CCommand.Option;

    public delegate bool ConfigReadFilter(string line);

    public abstract class CCommandTestFixture : AppTestFixtureBase
    {
        #region Setup

        protected override void RunSetUp()
        {
            base.RunSetUp();

            this.IsTrackConsoleLog = false;
            this.IsTrackTerminalLog = false;

            Clear();
        }

        protected override void RunTearDown()
        {
            Clear();
            base.RunTearDown();
        }

        protected virtual void Clear(bool deleteConfigs = true)
        {
            CBindings.Clear();
            CRegistery.Clear();

            if (deleteConfigs)
            {
                ConfigHelper.DeleteConfigs();
            }
        }

        #endregion

        #region Helpers

        protected void RegisterCommand(Type type, bool hidden = true)
        {
            CCommand command = ClassUtils.CreateInstance<CCommand>(type);
            if (command == null)
            {
                throw new ArgumentException("Can't create class instance: " + type.FullName);
            }

            String commandName = type.Name;
            if (commandName.StartsWith("Cmd_"))
            {
                commandName = commandName.Substring("Cmd_".Length);
            }

            command.Name = commandName;
            command.IsHidden = hidden;
            RuntimeResolver.ResolveOptions(command);

            CRegistery.Register(command);
        }

        protected void RegisterCommands(params string[] names)
        {
            foreach (string name in names)
            {
                Lunar.RegisterCommand(name, delegate(string[] args)
                {
                    AddResult(name);
                });
            }
        }

        protected void RegisterCommands(params CCommand[] commands)
        {
            foreach (CCommand cmd in commands)
            {
                CRegistery.Register(cmd);
            }
        }

        protected void AssertResult(params string[] expected)
        {
            AssertList(this.Result, expected);
        }

        protected void ClearResult()
        {
            this.Result.Clear();
        }

        protected bool Execute(string format, params object[] args)
        {
            return Execute(string.Format(format, args));
        }

        protected bool Execute(string commandLine, bool shouldSucceed = true)
        {
            bool result = App.ExecCommand(commandLine, true);
            Assert.IsFalse(result ^ shouldSucceed, "Command should " + (shouldSucceed ? "succeed" : "fail") + ": " + commandLine);
            return result;
        }

        protected void assertSuggestions(String line, params String[] expected)
        {
            int index = line.IndexOf('¶');
            Assert.IsTrue(index != -1);

            String[] actual = StringUtils.RemoveRichTextTags(CommandAutocompletion.getSuggestions(line.Replace("¶", ""), index));
            Assert.AreEqual(actual, expected);
        }

        #endregion

        #region Config

        protected void AssertConfig(params string[] expected)
        {
            AssertConfig(delegate(string line) { return true; }, expected);
        }

        protected void AssertConfig(ConfigReadFilter filter, params string[] expected)
        {
            IList<string> lines = ConfigHelper.ReadConfig(Constants.ConfigDefault);
            IList<string> actual = new List<string>();
            foreach (string line in lines)
            {
                if (filter(line))
                {
                    actual.Add(line);
                }
            }

            AssertList(actual, expected);
        }

        protected void WriteConfig(params string[] lines)
        {
            ConfigHelper.WriteConfig(Constants.ConfigDefault, lines);
        }

        #endregion
    }
}

